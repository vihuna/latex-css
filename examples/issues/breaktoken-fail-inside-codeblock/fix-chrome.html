<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>LaTeX.css Test â€” Fix breakToken fail inside code block</title>
  <meta name="description" content="LaTeX.css test: fix breakToken fail inside code block" />

  <link rel="stylesheet" href="../../../style.css" />
  <link rel="stylesheet" href="../../../prism/prism.css" />
  <link rel="stylesheet" href="../../../style-paged.css" />

  <style>
    @page {
      margin-top: 90pt;
      margin-right: 125pt;
      margin-bottom: 90pt;
      margin-left: 80pt;
    }
  </style>
</head>

<body id="top" class="toc-page-numbers sidenotes-outer">

  <main>
    <article>
      <p style="padding-top: 40pt;">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam
        accumsan vel magna id vehicula. Quisque scelerisque a ante sed
        semper. Aliquam felis velit, dapibus suscipit mi ut, imperdiet faucibus
        eros. Suspendisse vel mattis lectus. Duis vitae porta ex, in blandit
        velit. Donec tristique bibendum tincidunt. Duis eu leo mattis, euismod
        nunc sit amet, scelerisque lorem. Ut ac tellus imperdiet, pellentesque
        dui id, convallis elit. Nullam non ante ac quam sollicitudin
        auctor. Praesent congue ex justo, ut egestas mauris feugiat congue. Duis
        sagittis ante vel ex iaculis, eu venenatis leo auctor. Donec lectus
        massa, egestas quis posuere in, faucibus et dui. In congue libero quis
        lacinia scelerisque. Fusce accumsan, velit id commodo luctus, tortor
        elit faucibus neque, eu gravida ligula diam vitae nisi. Aliquam
        dignissim purus lobortis fringilla pretium.
      </p>

      <p>
        Duis et interdum nulla, at hendrerit ipsum. Aenean non finibus
        est. Mauris commodo odio in eros sollicitudin malesuada. Praesent
        pretium libero vel sollicitudin mollis Vestibulum ante ipsum primis in
        faucibus orci luctus et ultrices posuere cubilia curae; Praesent ut nunc
        at risus finibus scelerisque. Pellentesque in congue dui Donec eleifend,
        ex sed condimentum iaculis, lectus tortor posuere orci, sit amet dapibus
        justo ex quis neque. Aliquam malesuada ligula quis lobortis faucibus
        Curabitur dui libero, consequat at iaculis non, sollicitudin a
        elit. Curabitur dignissim eros felis, a euismod ligula bibendum a. Cras
        sit amet mauris vulputate urna semper aliquet.
      </p>

      <p>
        Vivamus urna magna, blandit non est eu, dapibus mollis urna. Nulla
        lacinia lectus accumsan nunc convallis semper. Nunc commodo odio vel
        auctor luctus. Vivamus luctus erat eleifend, tempor ligula sit amet,
        malesuada velit. Nulla facilisi. Curabitur ornare sit amet massa non
        gravida. Mauris vitae vehicula nisl. Pellentesque ultrices et dui eu
        posuere. Pellentesque habitant morbi tristique senectus et netus et
        malesuada fames ac turpis egestas. Etiam maximus, dolor id efficitur
        semper, nunc ligula malesuada mi, in vestibulum magna lacus tristique
        velit. Phasellus quis condimentum dolor. Donec arcu dolor, viverra quis
        elit feugiat, eleifend aliquet lectus. Donec tincidunt justo ac velit
        fringilla, euismod rhoncus orci varius. Nam vel mollis lorem.
      </p>

      <pre id="pre-error" style="white-space: pre; overflow-wrap: normal; overflow: visible; margin-top: 10pt;" class=" language-css"><code class=" language-css" style="white-space: pre; overflow-wrap: normal; overflow: visible;"><span class="token atrule"><span class="token rule">@media</span> print</span> <span class="token punctuation">{</span>
  <span class="token atrule"><span class="token rule">@page</span></span> <span class="token punctuation">{</span>
    <span class="token property">size</span><span class="token punctuation">:</span> A4 portrait<span class="token punctuation">;</span>
  ...
  <span class="token punctuation">}</span>
...
<span class="token punctuation">}</span></code></pre>

      <p>
        Etiam non venenatis velit. Nam eu libero eu orci pellentesque
        molestie. Sed dignissim massa in urna tempor cursus. Aliquam ac arcu
        nunc. Pellentesque malesuada accumsan varius. Donec placerat mauris quis
        augue vulputate semper. Phasellus risus ante, dictum gravida enim a,
        faucibus eleifend nulla. Fusce tincidunt dui mi, rutrum rutrum libero
        eleifend condimentum. Suspendisse vehicula luctus est, ac volutpat odio
        semper sed. Suspendisse id libero ipsum. Curabitur et tortor at arcu
        sodales fermentum sit amet at massa. In commodo tempus est quis
        auctor. Quisque feugiat porta justo nec congue. Morbi congue nunc vitae
        magna fringilla elementum. Nulla facilisi.
      </p>

    </article>
  </main>

  <!-- <script src="prism/prism.js"></script> -->
  <script>
    window.PagedConfig = {
      auto: false,
    };
    setTimeout(() => {
      window.PagedPolyfill.preview();
  }, 3000);
  </script>
  <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>

  <script>
    let breakTokenAdded;
    let latestCodeBlockOverflow;

    class fixCodeblockBreak extends Paged.Handler {
      constructor(chunker, polisher, caller) {
        super(chunker, polisher, caller);
      }

      // Add four test element after each code block
      beforeParsed(content) {
        const codeBlockAdjuster = document.createElement("div");
        codeBlockAdjuster.classList.add("code-block-adjuster");

        const codeBlockTestContainer = document.createElement("div");
        codeBlockTestContainer.classList.add("code-block-test");
        for (let i = 0; i < 4; i++) {
          const codeBlockTest = document.createElement("span");
          codeBlockTest.style.display = "none";
          codeBlockTest.classList.add("code-block-test");
          codeBlockTest.dataset.cbt = "cbt-" + i.toString();
          codeBlockTestContainer.append(codeBlockTest);
        }

        const codeBlockList = content.querySelectorAll("pre > code[class*='language-']");
        codeBlockList.forEach((el) => {
          const codeBlockEl = el.parentNode;
          codeBlockEl.before(codeBlockAdjuster.cloneNode(true));
          codeBlockEl.after(codeBlockTestContainer.cloneNode(true));
        });
      }

      renderNode(node, sourceNode, layout) {
        if (node.classList && node.classList.contains("code-block-test")) {
          if (!breakTokenAdded) {
            // No new page added after the code-block with overflow
            if (node.dataset.cbt === "cbt-0") {
              const codeBlockAdjusterDiv =
                node.parentNode.previousElementSibling.previousElementSibling;
              codeBlockAdjusterDiv.style.display = "block";
              codeBlockAdjusterDiv.style.height = "10pt";
              codeBlockAdjusterDiv.style["margin-top"] = "0";
            }
            if (node.dataset.cbt === "cbt-1") {
              const codeBlockAdjusterDiv =
                node.parentNode.previousElementSibling.previousElementSibling;
              codeBlockAdjusterDiv.style.display = "block";
              codeBlockAdjusterDiv.style.height = "30pt";
              codeBlockAdjusterDiv.style["margin-top"] = "0";
            }
            if (node.dataset.cbt === "cbt-2") {
              const codeBlockAdjusterDiv =
                node.parentNode.previousElementSibling.previousElementSibling;
              codeBlockAdjusterDiv.style.display = "block";
              codeBlockAdjusterDiv.style.height = "50pt";
              codeBlockAdjusterDiv.style["margin-top"] = "0";
            }
            if (node.dataset.cbt === "cbt-3") {
              console.warn(
                "LaTeX.css: possible pagination error while rendering a code block;",
                "check that there are no missing lines in the final document."
              );
            }
          }
        }

        if (node.tagName === "PRE" && layout.hasOverflow(node)) {
          breakTokenAdded = false;
        }
      }

      onBreakToken(breakToken, overflow, rendered) {
        breakTokenAdded = true;
        console.log(breakToken.node);
      }
    }
    Paged.registerHandlers(fixCodeblockBreak);
  </script>

</body>
</html>
